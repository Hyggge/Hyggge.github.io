<h1 id="lab4-挑战性任务实验报告">Lab4 挑战性任务实验报告</h1>
<h2 id="任务简介">任务简介</h2>
<p>Lab4的挑战性任务要求我们对MOS中以进程为单位的调度方式进行修改，实现线程相关机制，将作业调度的粒度缩小到线程，提高MOS的并发能力。此外，同一进程中的所有线程都共享进程中的资源，因此难免会出现资源竞争的现象。为了更好的控制线程之间的同步互斥关系，我们还需要实现信号量机制，从而保证各个线程能够按照我们的预期运行。</p>
<p>最终，我在任务中实现了以下用户态函数，并成功通过了自己的测试样例，达到了预期效果。<br />
- <strong>线程相关函数</strong><br />
- <strong>pthread_create</strong><br />
- <strong>pthread_exit</strong><br />
- <strong>pthread_cancel</strong><br />
- <strong>pthread_join</strong><br />
- <strong>pthread_testcancel</strong><br />
- <strong>pthread_self</strong><br />
- <strong>pthread_detach</strong><br />
- <strong>pthread_setcanceltype</strong><br />
 <br />
- <strong>信号量相关函数</strong><br />
- <strong>sem_init</strong><br />
- <strong>sem_destroy</strong><br />
- <strong>sem_wait</strong><br />
- <strong>sem_trywait</strong><br />
- <strong>sem_post</strong><br />
- <strong>sem_getvalue</strong></p>
<h2 id="线程相关机制">线程相关机制</h2>
<h3 id="数据结构">数据结构</h3>
<h4 id="线程控制块的设置">线程控制块的设置</h4>
<p>首先，我们需要引入记录线程相关状态的数据结构，从而实现对线程的控制。这个数据结构就是线程控制块——</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Thread <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    u_int thread_id<span class="op">;</span>        </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    u_int thread_pri<span class="op">;</span>       </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    u_int thread_tag<span class="op">;</span>       </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    u_int thread_status<span class="op">;</span>    </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Trapframe thread_tf<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    LIST_ENTRY<span class="op">(</span>Thread<span class="op">)</span> thread_sched_link<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span><span class="op">*</span> thread_retval<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span><span class="op">**</span> thread_retval_ptr<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    u_int thread_join_caller<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    u_int <span class="dt">thread_cancel_type</span><span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<ul>
<li><code>thread_id</code>是线程的<code>id</code>。<code>thread_id</code>包括两部分，0-4位表示该线程是所属进程中的第几号线程（每个进程中最多同时运行32个线程），4-31位记录线程所属进程的<code>envid</code>；</li>
<li><code>thread_pri</code>是线程的优先级。线程通过优先级来确定时间片的大小，属于同一进程的所有线程优先级相同。</li>
<li><code>thread_tag</code>是线程的标志位集合。这里采用状态压缩的方式，每一位分别表示不同的标志位。<br />
<code>cpp     #define THREAD_TAG_CANCELED    1    // bit0为1表示线程已经被cancel     #define THREAD_TAG_JOINED      2    // bit1为1表示线程已经被joined     #define THREAD_TAG_EXITED      4    // bit2为1表示线程已经调用过pthread_exit函数     #define THREAD_TAG_DETACHED    8    // bit3为1表示线程已经是分离状态</code></li>
<li><code>thread_status</code>表示线程的运行状态，可取值有<code>THREAD_FREE</code>，<code>THREAD_RUNNABLE</code>，<code>THREAD_NOT_RUNNABLE</code>。<br />
<code>cpp     #define THREAD_FREE             0     #define THREAD_RUNNABLE         1     #define THREAD_NOT_RUNNABLE     2</code></li>
<li><code>thread_tf</code>是用来存储寄存器现场的数据结构。在线程调出时，内核会将上下文存入其中，等到线程重新获得处理机资源时再恢复。</li>
<li><code>thread_retval</code>用来保存线程返回值。</li>
<li><code>thread_retval_ptr</code>是指向线程返回值的指针。该指针的拥有者是"调用join的线程"，指针指向的是"被join作用的线程的返回值"。</li>
<li><code>thread_join_caller</code>保存的是"调用join的线程"，而拥有这个变量的是"join作用的线程"。当某个线程结束时，如果它本身是被join的，则会将自身返回值<code>thread_retval</code>存储到<code>*(caller-&gt;thread_retval_ptr)</code>中。</li>
<li><code>thread_cancel_type</code>表示线程的撤销类型，可以取<code>THREAD_CANCEL_DEFREERD</code>和<code>THREAD_CANCEL_ASYNCHRONOUS</code>两个值。如果是前者，则表示被cancel作用后不立刻结束，需等待取消点的到来；如果是后者，则被cancel作用后会立即结束。<br />
<code>cpp     #define THREAD_CANCEL_DEFERRED          0     #define THREAD_CANCEL_ASYNCHRONOUS  1</code></li>
</ul>
<h4 id="进程控制块的修改">进程控制块的修改</h4>
<p>引入线程之后，进程的作用和地位就发生了改变，进程只作为系统资源的分配单元。因此，原来进程控制块中与调度相关的数据就不再需要了，例如<code>env_pop_tf</code>和<code>env_status</code>，取而代之的是和线程控制相关的数据。更改之后的进程控制块如下</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Env <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// struct Trapframe env_tf;         // Saved registers</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    LIST_ENTRY<span class="op">(</span>Env<span class="op">)</span> env_link<span class="op">;</span>           <span class="co">// Free list</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    u_int env_id<span class="op">;</span>                       <span class="co">// Unique environment identifier</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    u_int env_parent_id<span class="op">;</span>                <span class="co">// env_id of this env&#39;s parent</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// u_int env_status;                // Status of the environment</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    Pde  <span class="op">*</span>env_pgdir<span class="op">;</span>                    <span class="co">// Kernel virtual address of page dir</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    u_int env_cr3<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    u_int env_pri<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    LIST_ENTRY<span class="op">(</span>Env<span class="op">)</span> env_sched_link<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lab 4 IPC</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    u_int env_ipc_value<span class="op">;</span>                <span class="co">// data value sent to us </span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    u_int env_ipc_from<span class="op">;</span>                 <span class="co">// envid of the sender  </span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    u_int env_ipc_recving<span class="op">;</span>              <span class="co">// env is blocked receiving</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    u_int env_ipc_dstva<span class="op">;</span>        <span class="co">// va at which to map received page</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    u_int env_ipc_perm<span class="op">;</span>             <span class="co">// perm of page mapping received</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    u_int env_ipc_dst_thread<span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lab 4 fault handling</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    u_int env_pgfault_handler<span class="op">;</span>          <span class="co">// page fault state</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    u_int env_xstacktop<span class="op">;</span>                <span class="co">// top of exception stack</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lab 6 scheduler counts</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    u_int env_runs<span class="op">;</span>         <span class="co">// number of times been env_run&#39;ed</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    u_int env_nop<span class="op">;</span>                      <span class="co">// align to avoid mul instruction</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lab 4 challenge</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    u_int env_thread_bitmap<span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread env_threads<span class="op">[</span><span class="dv">32</span><span class="op">];</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>可以发现，删除<code>env_pop_tf</code>和<code>env_status</code>后，我们又新增了三个数据——<code>env_ipc_dst_thread</code>，<code>env_thread_bitmap</code>和<code>env_therads</code>。<br />
- <code>env_ipc_dst_thread</code>保存IPC交互过程中"读线程"的id。<br />
-
<code>env_thread_bitmap</code>是用来记录线程使用状态的位图。一个进程中最多有32个线程，正好对应整数的32个位。1表示线程已经被分配出去，状态可能是<code>RUNNABLE</code>或者<code>NOT_RUNNABLE</code>；0表示线程仍然是<code>FREE</code>状态，可以被申请。<br />
- <code>env_threads</code>中存储被该进程管理的32个线程的线程控制块。</p>
<h3 id="线程的创建和销毁">线程的创建和销毁</h3>
<p>每个进程的0号线程是该进程的主线程，主线程的PC初始值是用户程序镜像中的<code>entry point</code>，从而保证线程运行时直接执行用户程序中的<code>main</code>函数。每当创建一个新的进程时，该进程的主线程也随之被分配出去了。为了保证进程及其主线程同时创建、以及主线程能够从正确的PC开始运行，我们需要对原来的<code>env_alloc</code>、<code>env_create_priority</code>、<code>load_icode</code>等函数进行修改。</p>
<p>进程中的1-31号线程都是通过<code>pthread_create</code>函数创建出来的，我们姑且把这些线程称为子线程。子线程的运行入口是某个由用户创建的"线程运行函数"（相当于Java中的<code>run</code>方法），而并非是<code>main</code>函数，这是子线程和主线程的根本区别。</p>
<p>不论是子线程和主线程，在运行时都需要一定的栈空间。为了保证每个线程都拥有独立的栈空间，同时尽量避免不同线程的栈之间发生冲突，我从<code>USTACKTOP</code>开始为0-31号线程依次划分了4MB大小的空间，<code>USTACKTOP</code>是0号线程的栈顶，<code>USTACKTOP+4M</code>是1号线程的栈顶...以此类推。</p>
<p><img src="" /></p>
<p>接下来我们就可以编写进程的创建函数，从进程控制块中申请一个线程控制块，并对这个线程可控制块进行初始化。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> thread_alloc<span class="op">(</span><span class="kw">struct</span> Env <span class="op">*</span>e<span class="op">,</span> <span class="kw">struct</span> Thread <span class="op">**</span><span class="kw">new</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread <span class="op">*</span>t<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    u_int thread_id<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 申请一个线程控制块</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    thread_id <span class="op">=</span> mkthreadid<span class="op">(</span>e<span class="op">);</span>                      <span class="co">//申请一个新的id</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> <span class="op">&amp;</span>e<span class="op">-&gt;</span>env_threads<span class="op">[</span>THREAD2INDEX<span class="op">(</span>thread_id<span class="op">)];</span>   <span class="co">//根据id从进程控制块中获取新的线程控制块</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[1;33;40m&gt;&gt;&gt; thread </span><span class="sc">%d</span><span class="st"> is alloced ... (threads[</span><span class="sc">%d</span><span class="st">] of env </span><span class="sc">%d</span><span class="st">) &lt;&lt;&lt;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                thread_id<span class="op">,</span> THREAD2INDEX<span class="op">(</span>thread_id<span class="op">),</span> THREAD2ENVID<span class="op">(</span>thread_id<span class="op">));</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 进程控制初始化</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_id <span class="op">=</span> thread_id<span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_pri <span class="op">=</span> e<span class="op">-&gt;</span>env_pri<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_tag <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_status <span class="op">=</span> THREAD_RUNNABLE<span class="op">;</span>             <span class="co">//将线程的状态设置为runnable</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_retval <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_retval_ptr <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_join_caller <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span><span class="dt">thread_cancel_type</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_tf<span class="op">.</span>cp0_status <span class="op">=</span> <span class="bn">0x1000100c</span><span class="op">;</span> </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_tf<span class="op">.</span>regs<span class="op">[</span><span class="dv">29</span><span class="op">]</span> <span class="op">=</span> USTACKTOP <span class="op">-</span> <span class="dv">1024</span> <span class="op">*</span> BY2PG <span class="op">*</span> THREAD2INDEX<span class="op">(</span>thread_id<span class="op">);</span>   <span class="co">// 栈空间分配  </span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span><span class="kw">new</span> <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在线程运行函数正常结束，或者线程自己调用<code>pthread_exit</code>退出，或者线程被<code>join</code>作用时，需要释放相应的线程控制块，我们通过<code>thread_free</code>和<code>thread_destroy</code>函数实现。前者主要是将线程控制块标记成<code>FREE</code>，并在修改对应进程控制块的位图。后者在调用前者的基础上，判断进程中所有的线程是否都已经结束，如果是，则顺便调用<code>env_free</code>将进程也释放掉，随后直接<code>sched_yield</code>进行切换。</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> thread_free<span class="op">(</span><span class="kw">struct</span> Thread <span class="op">*</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Env <span class="op">*</span>e<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    e <span class="op">=</span> envs <span class="op">+</span> ENVX<span class="op">(</span>THREAD2ENVID<span class="op">(</span>t<span class="op">-&gt;</span>thread_id<span class="op">));</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    thread_index_free<span class="op">(</span>e<span class="op">,</span> THREAD2INDEX<span class="op">(</span>t<span class="op">-&gt;</span>thread_id<span class="op">));</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    t<span class="op">-&gt;</span>thread_status <span class="op">=</span> THREAD_FREE<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    LIST_REMOVE<span class="op">(</span>t<span class="op">,</span> thread_sched_link<span class="op">);</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> thread_destroy<span class="op">(</span><span class="kw">struct</span> Thread <span class="op">*</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Env <span class="op">*</span>e <span class="op">=</span> envs <span class="op">+</span> ENVX<span class="op">(</span>THREAD2ENVID<span class="op">(</span>t<span class="op">-&gt;</span>thread_id<span class="op">));</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    thread_free<span class="op">(</span>t<span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>curthread <span class="op">==</span> t<span class="op">)</span> curthread <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    bcopy<span class="op">(</span>KERNEL_SP <span class="op">-</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> Trapframe<span class="op">),</span> TIMESTACK <span class="op">-</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> Trapframe<span class="op">),</span> </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> Trapframe<span class="op">));</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[1;35;40m&gt;&gt;&gt; thread </span><span class="sc">%d</span><span class="st"> is killed ... (threads[</span><span class="sc">%d</span><span class="st">] of env </span><span class="sc">%d</span><span class="st">) &lt;&lt;&lt;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                t<span class="op">-&gt;</span>thread_id<span class="op">,</span> THREAD2INDEX<span class="op">(</span>t<span class="op">-&gt;</span>thread_id<span class="op">),</span> THREAD2ENVID<span class="op">(</span>t<span class="op">-&gt;</span>thread_id<span class="op">));</span> </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 随后判断进程中所用的线程是不是已经结束</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>e<span class="op">-&gt;</span>env_thread_bitmap <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        env_free<span class="op">(</span>e<span class="op">);</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[1;35;40m&gt;&gt;&gt; env </span><span class="sc">%d</span><span class="st"> is killed ...  &lt;&lt;&lt;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> e<span class="op">-&gt;</span>env_id<span class="op">);</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    sched_yield<span class="op">();</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="线程的调度">线程的调度</h3>
<p>线程创建出来后，还需要对其进行调度。线程的调度完全仿照进程的调度方法：<strong>采用两个队列（<code>thread_shced_list[2]</code>），用来存放可以被调度的线程的控制块。每创建出一个新的线程，我们就将该线程加入第一个队列的队首。在需要进行调度时，我们把当前已经用完时间片的线程放入另一个队列的队尾，并从当前队列的队首获取一个状态为<code>THREAD_RUNNABLE</code>的线程，让这个线程占用处理机资源。</strong></p>
<p>为了实现线程调度机制，我们需要对<code>sched_yield</code>函数进行修改。</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// sched.c</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="kw">struct</span> Thread<span class="op">*</span> curthread<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="kw">struct</span> Thread_list thread_sched_list<span class="op">[];</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sched_yield<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="dt">int</span> point <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread <span class="op">*</span>t <span class="op">=</span> curthread<span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>count <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> t <span class="op">==</span> NULL <span class="op">||</span> t<span class="op">-&gt;</span>thread_status <span class="op">!=</span> THREAD_RUNNABLE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>t <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            LIST_REMOVE<span class="op">(</span>t<span class="op">,</span> thread_sched_link<span class="op">);</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            LIST_INSERT_TAIL<span class="op">(&amp;</span>thread_sched_list<span class="op">[</span><span class="dv">1</span><span class="op">-</span>point<span class="op">],</span> t<span class="op">,</span> thread_sched_link<span class="op">);</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>LIST_EMPTY<span class="op">(&amp;</span>thread_sched_list<span class="op">[</span>point<span class="op">]))</span> <span class="op">{</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                point <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> point<span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> LIST_FIRST<span class="op">(&amp;</span>thread_sched_list<span class="op">[</span>point<span class="op">]);</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>t<span class="op">-&gt;</span>thread_status <span class="op">==</span> THREAD_RUNNABLE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                LIST_REMOVE<span class="op">(</span>t<span class="op">,</span> thread_sched_link<span class="op">);</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                LIST_INSERT_TAIL<span class="op">(&amp;</span>thread_sched_list<span class="op">[</span><span class="dv">1</span><span class="op">-</span>point<span class="op">],</span> t<span class="op">,</span> thread_sched_link<span class="op">);</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> t<span class="op">-&gt;</span>thread_pri<span class="op">;</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    count<span class="op">--;</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    thread_run<span class="op">(</span>t<span class="op">);</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对应的，我们仿照<code>env_run</code>函数编写一个<code>thread_run</code>函数。</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// thread.c</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> thread_run<span class="op">(</span><span class="kw">struct</span> Thread <span class="op">*</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Env <span class="op">*</span>e<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    e <span class="op">=</span> envs <span class="op">+</span> ENVX<span class="op">(</span>THREAD2ENVID<span class="op">(</span>t<span class="op">-&gt;</span>thread_id<span class="op">));</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>curthread <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> Trapframe <span class="op">*</span>old<span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        old <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> Trapframe <span class="op">*)(</span>TIMESTACK <span class="op">-</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> Trapframe<span class="op">));</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        bcopy<span class="op">(</span>old<span class="op">,</span> <span class="op">&amp;(</span>curthread<span class="op">-&gt;</span>thread_tf<span class="op">),</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> Trapframe<span class="op">));</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        curthread<span class="op">-&gt;</span>thread_tf<span class="op">.</span>pc <span class="op">=</span> old<span class="op">-&gt;</span>cp0_epc<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>curenv <span class="op">!=</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        curenv <span class="op">=</span> e<span class="op">;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        lcontext<span class="op">(</span>curenv<span class="op">-&gt;</span>env_pgdir<span class="op">);</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 和curenv类似，我们设置一个全局变量curthread来指向当前运行的线程的线程控制块</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    curthread <span class="op">=</span> t<span class="op">;</span>   </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    env_pop_tf<span class="op">(&amp;</span>t<span class="op">-&gt;</span>thread_tf<span class="op">,</span> GET_ENV_ASID<span class="op">(</span>e<span class="op">-&gt;</span>env_id<span class="op">));</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>有一个细节需要注意，如果换出的线程和换入的线程同属于一个进程，那我们不需要使用<code>lcontext</code>更换页表，这也就是线程切换比进程间的原因（线程很长一段时间被称作轻量级进程）。我们的MOS是运行在gxemul模拟器上的，虚实地址的转换也是采用软件模拟的（并没有采用硬件MMU）。当发生tlb中断时，模拟器会根据全局变量<code>context</code>中存储的页表地址来找到页表，并找到对应的页表项。因此，进程间切换时只需要把新进程页表的物理地址传给<code>context</code>变量即可，开销看上去也不大。<strong>但是如果运行在真正的硬件上，进程间切换时还涉及到进程页表从主存和内存之间的换入和换出，以及MMU的相关调整，时间开销就会比较大</strong>。</p>
<h3 id="相关系统调用">相关系统调用</h3>
<p>为了便于用户态函数的实现，我们需要设置一些系统调用函数提供内核服务——包括<strong>申请新的线程控制块、销毁线程控制块、获得当前运行线程的id、将线程加入或移出调度队列</strong>等等。线程操作相关的系统调用包括——<br />
-
<strong>syscall_thread_alloc</strong>：该函数用于申请新的线程控制块，直接调用<code>thread_alloc</code>函数即可。<br />
```cpp<br />
int sys_thread_alloc(int sysno) {<br />
int ret;<br />
struct Thread *t;</p>
<pre><code>    ret = thread_alloc(curenv, &amp;t); 
    if (ret &lt; 0) return ret;

    return t-&gt;thread_id;
}
```</code></pre>
<ul>
<li><p><strong>syscall_thread_destroy</strong>：该函数在线程运行函数正常结束、线程自己调用exit退出、线程被join作用时被调用，释放线程占用的资源。需要注意的是，如果被结束的线程拥有<code>THREAD_TAG_CANCELED</code>这一标志位，还需要将自身的返回值"告知"join函数的调用者。<br />
```cpp</p>
<p>int sys_thread_destroy(int sysno, u_int threadid) {<br />
int ret;<br />
struct Thread *t;</p>
<pre><code>  ret = id2thread(threadid, &amp;t);
  if (ret &lt; 0) return ret;

  if (t-&gt;thread_status == THREAD_FREE) {
      return -E_INVAL;
  }

  if ((t-&gt;thread_tag &amp; THREAD_TAG_JOINED) != 0) {
      u_int caller_id = t-&gt;thread_join_caller;     
      // 找到join函数的调用线程   
      struct Thread * caller = &amp;curenv-&gt;env_threads[THREAD2INDEX(caller_id)];    
      if (caller-&gt;thread_retval_ptr != NULL) {     
          // 将自身的返回值&quot;告知&quot;join函数的调用者     
          *(caller-&gt;thread_retval_ptr) = t-&gt;thread_retval;    
      }
      caller-&gt;thread_status = THREAD_RUNNABLE;
  }  

  thread_destroy(t);  // 调用thread_destory函数来释放其他的内容
  return 0;</code></pre>
<p>}<br />
```</p></li>
<li><p><code>syscall_set_thread_status</code>：设置线程的运行状态，同时根据状态的改变将线程控制块加入或者移出调度队列。具体实现和<code>syscall_set_env_status</code>完全一样，照葫芦画瓢即可。<br />
```cpp<br />
int sys_set_thread_status(int sysno, u_int threadid, u_int status)
{<br />
int ret;<br />
struct Thread *t;</p>
<pre><code>  if (status != THREAD_RUNNABLE &amp;&amp; status != THREAD_FREE &amp;&amp; status != THREAD_NOT_RUNNABLE) {
      return -E_INVAL;
  }

  ret = id2thread(threadid, &amp;t);
  if (ret &lt; 0) return ret;

  if (status == THREAD_RUNNABLE &amp;&amp; t-&gt;thread_status != THREAD_RUNNABLE) {
      LIST_INSERT_HEAD(&amp;thread_sched_list[0], t, thread_sched_link);
  }

  if (status != THREAD_RUNNABLE &amp;&amp; t-&gt;thread_status == THREAD_RUNNABLE) {
      LIST_REMOVE(t, thread_sched_link);
  }

  t-&gt;thread_status = status;
  return 0;</code></pre>
<p>}<br />
```</p></li>
<li><p><code>syscall_get_thread_id</code>：获取当前运行的线程的id，直接调用从<code>curthread</code>指向的线程控制块中找即可。<br />
```cpp<br />
int sys_get_thread_id(int sysno) {</p>
<pre><code>  return curthread-&gt;thread_id;</code></pre>
<p>}<br />
```</p></li>
</ul>
<h3 id="用户接口的实现">用户接口的实现</h3>
<p>编写好系统调用之后，我们就可以利用它们实现用户态的接口函数。<br />
-
<strong>pthread_create</strong>：通过<code>syscall_thread_alloc</code>申请一个线程，然后对<code>pc</code>、<code>a0</code>、<code>sp</code>、<code>ra</code>等寄存器进行赋值，保证新创建的子线程能够正确的进入线程运行函数，并最终进入<code>exit</code>函数结束。<br />
```cpp<br />
int pthread_create(pthread_t <em>thread, const pthread_attr_t
</em>attr,<br />
void * (<em>start_rountine)(void </em>), void <em>arg) {<br />
u_int thread_id;<br />
struct Thread </em>t;</p>
<pre><code>    thread_id = syscall_thread_alloc();
    if (thread_id &lt; 0) {
        *thread = NULL;
        return thread_id;
    }

    t = &amp;env-&gt;env_threads[THREAD2INDEX(thread_id)];
    t-&gt;thread_tf.pc = start_rountine;   // 保证子线程能够进入线程运行函数
    t-&gt;thread_tf.regs[4] = arg;         // 传递参数
    t-&gt;thread_tf.regs[29] -= 4;         // 在栈上预留空间，符合MIPS函数调用的规范
    t-&gt;thread_tf.regs[31] = exit;       // 保证子线程退出线程运行函数后，能够进入exit函数释放进程控制块。


    syscall_set_thread_status(thread_id, THREAD_RUNNABLE);
    *thread = thread_id;
    return 0;
}
```</code></pre>
<ul>
<li><p><strong>pthread_exit</strong>：调用这个函数会把线程本身中止，如果需要返回某个值，只需要将返回值作为参数传给该函数即可。这个函数首先获得当前运行的线程的线程控制块，然后把返回值复制给<code>thread_retval</code>，并标记上<code>THREAD_TAG_EXITED</code>，最后直接调用<code>exit</code>返回即可。当某个线程调用了join函数，而且join的目标时该进程，则它会从该线程的<code>thread_retval</code>中获得（在系统调用<code>sys_thread_destroy</code>中有这个机制）。<br />
``` c++<br />
void pthread_exit(void <em>retval) {<br />
u_int thread_id;<br />
struct Thread </em>cur;<br />
thread_id = syscall_get_thread_id();<br />
cur = &amp;env-&gt;env_threads[THREAD2INDEX(thread_id)];</p>
<pre><code>  cur-&gt;thread_retval = retval;
  cur-&gt;thread_tag |= THREAD_TAG_EXITED;
  exit();</code></pre>
<p>}<br />
```</p></li>
<li><p><strong>pthread_cancel</strong>：该函数可以将指定的线程撤销，不过还需要对目标线程的标志位进行检查。对于处于<code>FREE</code>状态的线程、处于分离状态的线程、已经被撤销过的线程、已经调用<code>pthread_exit</code>自杀的线程（自杀但是没来的及destroy），我们不能通过该函数取消它们。else里的内容才是正常情况下做出的操作——</p>
<ul>
<li>将目标线程标记为THREAD_TAG_CANCELED</li>
<li>将PTHREAD_CANCELED设置为返回值（笔者将其设置为666）</li>
<li>如果目标线程的撤销类型时THREAD_CANCEL_ASYNCHRONOUS，我们需要让目标线程在下一次被调度时直接进入exit函数。</li>
</ul>
<div class="sourceCode" id="cb13"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> pthread_cancel<span class="op">(</span><span class="dt">pthread_t</span> thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread <span class="op">*</span>t<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> <span class="op">&amp;</span>env<span class="op">-&gt;</span>env_threads<span class="op">[</span>THREAD2INDEX<span class="op">(</span>thread<span class="op">)];</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>t<span class="op">-&gt;</span>thread_id <span class="op">!=</span> thread <span class="op">||</span> t<span class="op">-&gt;</span>thread_status <span class="op">==</span> THREAD_FREE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_NOT_FOUND<span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>t<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_DETACHED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_DETACHED<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>t<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_CANCELED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_CANCELED<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>t<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_EXITED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_EXITED<span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        t<span class="op">-&gt;</span>thread_tag <span class="op">|=</span> THREAD_TAG_CANCELED<span class="op">;</span>       <span class="co">// 将目标线程标记为THREAD_TAG_CANCELED</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        t<span class="op">-&gt;</span>thread_retval <span class="op">=</span> PTHREAD_CANCELED<span class="op">;</span>        <span class="co">// 将PTHREAD_CANCELED设置为返回值</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>t<span class="op">-&gt;</span><span class="dt">thread_cancel_type</span> <span class="op">==</span> THREAD_CANCEL_ASYNCHRONOUS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>thread <span class="op">==</span> syscall_get_thread_id<span class="op">())</span> <span class="op">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>                exit<span class="op">();</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> t<span class="op">-&gt;</span>thread_tf<span class="op">.</span>pc <span class="op">=</span> exit<span class="op">;</span>            <span class="co">// 结束该进程 </span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p><strong>pthread_join</strong>：调用该函数后，会将当前线程阻塞至目标线程结束。</p>
<ul>
<li>对于已经处于分离状态、或者已经被join的线程，我们无法对其调用join。</li>
<li>对于已经处于<code>FREE</code>状态、已经结束了的线程，我们不需要将join调用者阻塞，直接从目标线程的<code>thread_retval</code>中获取返回值即可。</li>
<li>对于其他线程，我们可以对其调用join，但是调用线程必须等待。注意<code>curthread-&gt;thread_retval_ptr = retval_ptr</code>这步比较关键——将指针<code>retval_ptr</code>赋值给调用者的<code>thread_retval_ptr</code>，当目标进程结束后，会直接将返回值写入<code>*(调用者-&gt;thread_retval_ptr)</code>，这和写入<code>*retval_ptr</code>是等价的（在<code>sys_thread_destroy</code>中有相关机制）。</li>
</ul>
<div class="sourceCode" id="cb14"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> pthread_join<span class="op">(</span><span class="dt">pthread_t</span> thread<span class="op">,</span> <span class="dt">void</span> <span class="op">**</span>retval_ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread <span class="op">*</span>dst<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    dst <span class="op">=</span> <span class="op">&amp;</span>env<span class="op">-&gt;</span>env_threads<span class="op">[</span>THREAD2INDEX<span class="op">(</span>thread<span class="op">)];</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>dst<span class="op">-&gt;</span>thread_id <span class="op">!=</span> thread<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_NOT_FOUND<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>dst<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_DETACHED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_DETACHED<span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>dst<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_JOINED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_JOINED<span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>dst<span class="op">-&gt;</span>thread_status <span class="op">==</span> THREAD_FREE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>retval_ptr <span class="op">!=</span> NULL<span class="op">)</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span>retval_ptr <span class="op">=</span> dst<span class="op">-&gt;</span>thread_retval<span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    dst<span class="op">-&gt;</span>thread_tag <span class="op">|=</span> THREAD_TAG_JOINED<span class="op">;</span>               <span class="co">// 将目标线程标记上THREAD_TAG_JOINED</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    dst<span class="op">-&gt;</span>thread_join_caller <span class="op">=</span> curthread<span class="op">-&gt;</span>thread_id<span class="op">;</span>     <span class="co">// 把调用者的id记录在目标线程的线程控制块中</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    curthread<span class="op">-&gt;</span>thread_retval_ptr <span class="op">=</span> retval_ptr<span class="op">;</span>          <span class="co">// 将传入的指针retval_ptr赋值给thread_retval_ptr</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    curthread<span class="op">-&gt;</span>thread_status <span class="op">=</span> THREAD_NOT_RUNNABLE<span class="op">;</span>     <span class="co">// 将当前线程阻塞</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    syscall_yield<span class="op">();</span>                                    <span class="co">// 切换线程</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p><strong>pthread_detach</strong>：将目标线程设置为分离状态，对于处于分离状态的线程，其他线程无法对其使用join、detach、cancel等函数。此外，我们不能对已经是<code>FREE</code>状态的、或者已经处于分离状态、或者已经被join的线程使用该函数。<br />
```cpp<br />
int pthread_detach(pthread_t thread) {<br />
struct Thread *dst;<br />
dst = &amp;env-&gt;env_threads[THREAD2INDEX(thread)];</p>
<pre><code>  if (dst-&gt;thread_id != thread  || dst-&gt;thread_status == THREAD_FREE) {
      return -E_THREAD_NOT_FOUND;
  } 
  else if ((dst-&gt;thread_tag &amp; THREAD_TAG_DETACHED) != 0) {
      return -E_THREAD_DETACHED;
  }
  else if ((dst-&gt;thread_tag &amp; THREAD_TAG_JOINED) != 0) {
      return -E_THREAD_JOINED;
  }

  dst-&gt;thread_tag |= THREAD_TAG_DETACHED;
  return 0;</code></pre>
<p>}<br />
```</p></li>
<li><p><strong>pthread_setcanceltype</strong>：默认情况下，线程的cancel
type都是<code>THREAD_CANCEL_DEFERRED</code>，而该函数修改进程的<code>cancel type</code>，并通过<code>oldtype</code>获得原值。<br />
```cpp<br />
int pthread_setcanceltype(int type, int <em>oldtype) {<br />
u_int thread_id = syscall_get_thread_id();<br />
struct Thread </em>cur =
&amp;env-&gt;env_threads[THREAD2INDEX(thread_id)];</p>
<pre><code>  if (oldtype) {
      *oldtype = cur-&gt;thread_cancel_type;
  }

  cur-&gt;thread_cancel_type = type;
  return 0;</code></pre>
<p>}<br />
```</p></li>
<li><p><strong>pthread_teatcancel</strong>：对于<code>cancel type</code>是<code>THREAD_CANCEL_DEFERRED</code>的线程来说，被cancel函数作用后并不会立刻结束，而是到达某一个"取消点"才会结束自己。而这个函数可以帮助手动设置取消点，当某一个线程运行到该函数时，如果满足条件就直接进入exit函数退出。必须满足条件有两个——</p>
<ul>
<li>当前进程必须join函数作用过，即存在<code>THREAD_CANCEL_DEFERRED</code>标记。</li>
<li>当前进程的<code>cancel type</code>必须是<code>THREAD_CANCEL_DEFERRED</code>，即默认状态。</li>
</ul>
<div class="sourceCode" id="cb17"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> pthread_testcancel<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    u_int thread_id<span class="op">;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread <span class="op">*</span>cur<span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    thread_id <span class="op">=</span> syscall_get_thread_id<span class="op">();</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">=</span> <span class="op">&amp;</span>env<span class="op">-&gt;</span>env_threads<span class="op">[</span>THREAD2INDEX<span class="op">(</span>thread_id<span class="op">)];</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>cur<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_CANCELED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>            cur<span class="op">-&gt;</span><span class="dt">thread_cancel_type</span> <span class="op">==</span> THREAD_CANCEL_DEFERRED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">();</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p><strong>pthread_self</strong>：该函数可以让线程获得自己的id，只需要调用<code>syscall_get_thread_id</code>即可。<br />
``` c++<br />
pthread_t pthread_self() {</p>
<pre><code>  return syscall_get_thread_id();</code></pre>
<p>}<br />
```</p></li>
</ul>
<h3 id="其他细节">其他细节</h3>
<h4 id="exit">exit</h4>
<p>所有正常或者非正常结束的线程最后都会进入<code>exit</code>函数，而这个函数也有很多细节需要注意。笔者改写的<code>exit</code>函数如下图所示</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>exit<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">//  writef(&quot;enter exit!&quot;);</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//close_all();</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>retval <span class="op">=</span> get_retval<span class="op">();</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> thread_id <span class="op">=</span> syscall_get_thread_id<span class="op">();</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread <span class="op">*</span>cur_thread <span class="op">=</span> <span class="op">&amp;</span>env<span class="op">-&gt;</span>env_threads<span class="op">[</span>THREAD2INDEX<span class="op">(</span>thread_id<span class="op">)];</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// THREAD2INDEX(thread_id)表示&quot;该线程是所属进程的第几号线程</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>THREAD2INDEX<span class="op">(</span>thread_id<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        cur_thread<span class="op">-&gt;</span>thread_retval <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        syscall_thread_destroy<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>cur_thread<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_CANCELED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        syscall_thread_destroy<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>cur_thread<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_EXITED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        cur_thread<span class="op">-&gt;</span>thread_retval <span class="op">=</span> retval<span class="op">;</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        syscall_thread_destroy<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li>对于0号线程，也就是主线程，它先执行<code>umain</code>函数然后再进入<code>exit</code>，由于<code>umain</code>函数是没有返回值的，因此我们需要手动将<code>0</code>作为主线程返回值。但是实际上，一般不会出现"子线程获取主线程的返回值"，所以这里可有可无。</li>
<li>对于标志位有<code>THREAD_TAG_CANCELED</code>或者<code>THREAD_TAG_EXITED</code>的子线程，这些线程都是通过exit或者cancel函数非正常结束的，而且在这两个函数中都已经把"返回值"赋值给<code>thread_retval</code>，所以在这里只需要调用<code>syscall_thread_destroy</code>释放线程资源即可。</li>
<li>对于正常结束的子线程，尽管是有返回值，但是由于执行完"线程运行函数"后直接跳转到了<code>exit</code>，"线程运行函数"的返回值我们无法直接获取。为此，笔者特地写了一个汇编函数<code>get_retval</code>来获得"线程运行函数"的返回值。<br />
<code>cpp     LEAF(get_retval)         j    ra     END(get_retval)</code><br />
我们把<code>get_retval</code>作为<code>exit</code>中运行的第一个函数，由于<code>get_retval</code>没有修改<code>v0寄</code>存器，因此它的返回值和"线程运行函数"的返回值一致。</li>
</ul>
<h4 id="pthread_join的线程安全">pthread_join的线程安全</h4>
<p>上面介绍的<code>pthread_join</code>函数的实现是在用户态中实现的，但是笔者在测试中发现，由于线程执行顺序的随机性会带来一些线程安全问题。</p>
<p>假设线程A调用join函数，并作用于线程B。<br />
-
当线程A执行<code>if (dst-&gt;thread_status == THREAD_FREE)</code>时，发现线程B并不是FREE状态，接着发生时钟中断，切换到了线程B。<br />
-
线程B执行完并正常退出，状态变成了<code>FREE</code>，然后切换到了线程A。<br />
-
线程A由于此前判断出"线程B不是<code>FREE</code>状态"，因此跳过了if，执行后续操作（被阻塞）。<br />
-
线程A被阻塞了，但是线程B早就执行完<code>syscall_thread_destroy</code>恢复清白之身了，无法唤醒线程A</p>
<p>为了解决这个问题，笔者将<code>pthread_join</code>函数中的操作封装成了系统调用——</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> pthread_join<span class="op">(</span><span class="dt">pthread_t</span> thread<span class="op">,</span> <span class="dt">void</span> <span class="op">**</span>retval_ptr<span class="op">)</span> <span class="op">{</span>   </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> syscall_thread_join<span class="op">(</span>thread<span class="op">,</span> retval_ptr<span class="op">);</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">// 新增系统调用函数</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sys_thread_join<span class="op">(</span><span class="dt">int</span> sysno<span class="op">,</span> u_int thread_id<span class="op">,</span> <span class="dt">void</span> <span class="op">**</span>retval_ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread <span class="op">*</span>dst<span class="op">;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> id2thread<span class="op">(</span>thread_id<span class="op">,</span> <span class="op">&amp;</span>dst<span class="op">);</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> ret<span class="op">;</span> </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>dst<span class="op">-&gt;</span>thread_id <span class="op">!=</span> thread_id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_NOT_FOUND<span class="op">;</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>dst<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_DETACHED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_DETACHED<span class="op">;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">((</span>dst<span class="op">-&gt;</span>thread_tag <span class="op">&amp;</span> THREAD_TAG_JOINED<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>E_THREAD_JOINED<span class="op">;</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>dst<span class="op">-&gt;</span>thread_status <span class="op">==</span> THREAD_FREE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>retval_ptr <span class="op">!=</span> NULL<span class="op">)</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span>retval_ptr <span class="op">=</span> dst<span class="op">-&gt;</span>thread_retval<span class="op">;</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    dst<span class="op">-&gt;</span>thread_tag <span class="op">|=</span> THREAD_TAG_JOINED<span class="op">;</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    dst<span class="op">-&gt;</span>thread_join_caller <span class="op">=</span> curthread<span class="op">-&gt;</span>thread_id<span class="op">;</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    curthread<span class="op">-&gt;</span>thread_retval_ptr <span class="op">=</span> retval_ptr<span class="op">;</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    curthread<span class="op">-&gt;</span>thread_status <span class="op">=</span> THREAD_NOT_RUNNABLE<span class="op">;</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Trapframe <span class="op">*</span>tf <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> Trapframe <span class="op">*)(</span>KERNEL_SP <span class="op">-</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> Trapframe<span class="op">));</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    tf<span class="op">-&gt;</span>regs<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>    <span class="co">// 设置返回值为0</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    sys_yield<span class="op">();</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="信号量机制">信号量机制</h2>
<h3 id="数据结构-1">数据结构</h3>
<p>信号量机制的实现同样离不开一定的数据结构。笔者编写了<code>Semaphore</code>这一结构体，并将其作为信号量的类型(sem_t)。</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Semaphore <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    u_int sem_perm<span class="op">;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> sem_value<span class="op">;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Thread<span class="op">*</span> sem_wait_queue<span class="op">[</span><span class="dv">32</span><span class="op">];</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    u_int sem_queue_head<span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    u_int sem_queue_tail<span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<ul>
<li><code>sem_perm</code>是信号量的标志位集合，同样采用了状态压缩的方式，<code>bit0</code>是信号量的"有效位"，<code>bit1</code>是信号量的"共享位"。<br />
<code>cpp     #define SEM_PERM_VALID          1     #define SEM_PERM_SHARE          2</code></li>
<li><code>sem_value</code>是信号量的当前值。</li>
<li><code>sem_wait_queue</code>是存储被阻塞线程的环形队列，因为进程最多只能同时运行32个线程，因此唤醒队列的长度也是32</li>
<li><code>sem_queue_head</code>是环形队列的队首下标</li>
<li><code>sem_queue_tail</code>是环形队列的队尾下标</li>
</ul>
<h3 id="用户接口函数的实现">用户接口函数的实现</h3>
<p>信号量的使用是为了解决线程高并发带来的同步互斥问题，因此信号量本身的各种操作也必须是原子的。为了保证原子性，笔者为每一个用户接口函数设置了对应的系统调用函数。</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sem_init <span class="op">(</span><span class="dt">sem_t</span> <span class="op">*</span>sem<span class="op">,</span> <span class="dt">int</span> pshared<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> syscall_sem_init<span class="op">(</span>sem<span class="op">,</span> pshared<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sem_destroy <span class="op">(</span><span class="dt">sem_t</span> <span class="op">*</span>sem<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> syscall_sem_destroy<span class="op">(</span>sem<span class="op">);</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sem_wait <span class="op">(</span><span class="dt">sem_t</span> <span class="op">*</span>sem<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> syscall_sem_wait<span class="op">(</span>sem<span class="op">);</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sem_trywait<span class="op">(</span><span class="dt">sem_t</span> <span class="op">*</span>sem<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> syscall_sem_trywait<span class="op">(</span>sem<span class="op">);</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sem_post <span class="op">(</span><span class="dt">sem_t</span> <span class="op">*</span>sem<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> syscall_sem_post<span class="op">(</span>sem<span class="op">);</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sem_getvalue <span class="op">(</span><span class="dt">sem_t</span> <span class="op">*</span>sem<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>valp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> syscall_sem_getvalue<span class="op">(</span>sem<span class="op">,</span> valp<span class="op">);</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>各个系统调用的实现如下——<br />
-
<strong>sys_sem_init</strong>：这个函数主要是对信号量进行初始化，需要将参数赋值给<code>sem_value</code>，设置标志位，并将其他数据成员的值设为0。<br />
```cpp<br />
int sys_sem_init (int sysno, sem_t *sem, int pshared, unsigned int
value) {<br />
if (sem == NULL) {<br />
return -E_SEM_NOT_FOUND;<br />
}</p>
<pre><code>    sem-&gt;sem_value = value;
    sem-&gt;sem_queue_head = 0; 
    sem-&gt;sem_queue_tail = 0;
    sem-&gt;sem_perm |= SEM_PERM_VALID;

    if (pshared) {
        sem-&gt;sem_perm |= SEM_PERM_SHARE;
    }

    int i;
    for (i = 0; i &lt; 32; i++) {
        sem-&gt;sem_wait_queue[i] = NULL;
    }
    return 0;
}
```</code></pre>
<ul>
<li><p><strong>sys_sem_destroy</strong>：该函数需要销毁信号量，只需要将信号量的<code>VALID</code>标志位设置位0即可。但是需要注意的是，如果目前还有阻塞在信号量上的线程，则信号量无法被销毁。<br />
<code>cpp     int sys_sem_destroy (int sysno, sem_t *sem) {         if ((sem-&gt;sem_perm &amp; SEM_PERM_VALID) == 0) {    // 无法销毁无效的信号量             return -E_SEM_INVALID;         }         if (sem-&gt;sem_queue_head != sem-&gt;sem_queue_tail) {             return -E_SEM_DESTROY_FAIL;                  }         sem-&gt;sem_perm &amp;= ~SEM_PERM_VALID;         return 0;     }</code></p></li>
<li><p><strong>sys_sem_wait</strong>：调用该函数后，<code>sem_value</code>会自减。如果自减之后<code>sem_value</code>的值小于0，则会将调用者加入信号量的阻塞队列中，并将该线程状态设置为<code>THREAD_NOT_RUNNABLE</code>，实现阻塞。<br />
```cpp<br />
int sys_sem_wait (int sysno, sem_t *sem) {<br />
if ((sem-&gt;sem_perm &amp; SEM_PERM_VALID) == 0) {<br />
return -E_SEM_INVALID;<br />
}</p>
<pre><code>  sem-&gt;sem_value--;
  if (sem-&gt;sem_value &gt;= 0) {
      return 0;
  }

  // if sem_value &lt; 0 
  if (sem-&gt;sem_value &lt; -32) {
      return -E_SEM_WAIT_MAX;
  }

  // must wait
  sem-&gt;sem_wait_queue[sem-&gt;sem_queue_tail] = curthread;
  sem-&gt;sem_queue_tail = (sem-&gt;sem_queue_tail + 1) % 32;

  curthread-&gt;thread_status = THREAD_NOT_RUNNABLE;     //阻塞线程

  struct Trapframe *tf = 
      (struct Trapframe *)(KERNEL_SP - sizeof(struct Trapframe));
  tf-&gt;regs[2] = 0;        // 将返回值设置为0
  sys_yield();</code></pre>
<p>}<br />
```</p></li>
<li><p><strong>sys_sem_trywait</strong>：调用该函数后，<code>sem_value</code>会自减。如果自减之后<code>sem_value</code>的值小于0，则会返回错误码，不会对调用者产生任何阻塞效果。<br />
```cpp<br />
int sys_sem_trywait(int sysno, sem_t *sem) {<br />
if ((sem-&gt;sem_perm &amp; SEM_PERM_VALID) == 0) {<br />
return -E_SEM_INVALID;<br />
}</p>
<pre><code>  sem-&gt;sem_value--;
  if (sem-&gt;sem_value &gt;= 0) {
      return 0;
  }
  return -E_SEM_TRYWAIT_FAIL;</code></pre>
<p>}<br />
```</p></li>
<li><p><strong>sys_sem_post</strong>：调用该函数后，<code>sem_value</code>会自增。如果自增之后<code>sem_value</code>的值是小于等于0，则说明当前有阻塞在该信号量上的线程，我们需要从队首获得一个线程并将其唤醒。<br />
```cpp<br />
int sys_sem_post (int sysno, sem_t <em>sem) {<br />
struct Thread </em>t;</p>
<pre><code>  if ((sem-&gt;sem_perm &amp; SEM_PERM_VALID) == 0) {
      return -E_SEM_INVALID;
  }

  sem-&gt;sem_value++; 
  if (sem-&gt;sem_value &lt;= 0) {
      t = sem-&gt;sem_wait_queue[sem-&gt;sem_queue_head];
      sem-&gt;sem_queue_head = (sem-&gt;sem_queue_head + 1) % 32;
      t-&gt;thread_status = THREAD_RUNNABLE;  // 唤醒线程
  }
  return 0;</code></pre>
<p>}<br />
```</p></li>
<li><p><strong>sys_sem_getvalue</strong>：该函数可以返回目标信号量的当前值，直接返回<code>sem_value</code>即可。对于没有被初始化的信号量，也就是<code>VALID</code>位是0的信号量，直接返回错误码<br />
<code>cpp     int sys_sem_getvalue (int sysno, sem_t *sem, int *valp) {         if ((sem-&gt;sem_perm &amp; SEM_PERM_VALID) == 0) {             return -E_SEM_INVALID;         }         if (valp) {             *valp = sem-&gt;sem_value;         }         return 0;     }</code></p></li>
</ul>
<h2 id="关于测试">关于测试</h2>
<h3 id="线程创建等待返回值测试">线程创建、等待、返回值测试</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t2<span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>print_message_function<span class="op">(</span> <span class="dt">void</span> <span class="op">*</span>ptr <span class="op">)</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id <span class="op">=</span> pthread_self<span class="op">();</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m thread </span><span class="sc">%d</span><span class="st"> received : &#39;</span><span class="sc">%s</span><span class="st">&#39; </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">,</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>ptr<span class="op">);</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>id <span class="op">==</span> t1<span class="op">)</span> <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>umain<span class="op">()</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>message1 <span class="op">=</span> <span class="st">&quot;I love BUAA!&quot;</span><span class="op">;</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>message2 <span class="op">=</span> <span class="st">&quot;I love CS!&quot;</span><span class="op">;</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>  ret1<span class="op">,</span> ret2<span class="op">;</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(</span> <span class="op">&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> print_message_function<span class="op">,</span> <span class="op">(</span><span class="dt">void</span><span class="op">*)</span> message1<span class="op">);</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(</span> <span class="op">&amp;</span>t2<span class="op">,</span> NULL<span class="op">,</span> print_message_function<span class="op">,</span> <span class="op">(</span><span class="dt">void</span><span class="op">*)</span> message2<span class="op">);</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span> t1<span class="op">,</span> <span class="op">&amp;</span>ret1<span class="op">);</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span> t2<span class="op">,</span> <span class="op">&amp;</span>ret2<span class="op">);</span> </span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m thread </span><span class="sc">%d</span><span class="st"> returns: </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> t1<span class="op">,</span> ret1<span class="op">);</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m thread </span><span class="sc">%d</span><span class="st"> returns: </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> t2<span class="op">,</span> ret2<span class="op">);</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong></p>
<p><img src="线程创建基本函数.jpg" /></p>
<h3 id="pthread_exit测试">pthread_exit测试</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t2<span class="op">;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>print_message_function<span class="op">(</span> <span class="dt">void</span> <span class="op">*</span>ptr <span class="op">)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> id <span class="op">=</span> pthread_self<span class="op">();</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m thread </span><span class="sc">%d</span><span class="st"> received : &#39;</span><span class="sc">%s</span><span class="st">&#39; </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">,</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>ptr<span class="op">);</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m before `pthread_exit` ...</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">);</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>id <span class="op">==</span> t1<span class="op">)</span> pthread_exit<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> pthread_exit<span class="op">(</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m after `pthread_exit` ...</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>id <span class="op">==</span> t1<span class="op">)</span> <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>umain<span class="op">()</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>message1 <span class="op">=</span> <span class="st">&quot;I love BUAA!&quot;</span><span class="op">;</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>message2 <span class="op">=</span> <span class="st">&quot;I love CS!&quot;</span><span class="op">;</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>  ret1<span class="op">,</span> ret2<span class="op">;</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(</span> <span class="op">&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> print_message_function<span class="op">,</span> <span class="op">(</span><span class="dt">void</span><span class="op">*)</span> message1<span class="op">);</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(</span> <span class="op">&amp;</span>t2<span class="op">,</span> NULL<span class="op">,</span> print_message_function<span class="op">,</span> <span class="op">(</span><span class="dt">void</span><span class="op">*)</span> message2<span class="op">);</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span> t1<span class="op">,</span> <span class="op">&amp;</span>ret1<span class="op">);</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span> t2<span class="op">,</span> <span class="op">&amp;</span>ret2<span class="op">);</span> </span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m thread </span><span class="sc">%d</span><span class="st"> returns: </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> t1<span class="op">,</span> ret1<span class="op">);</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m thread </span><span class="sc">%d</span><span class="st"> returns: </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> t2<span class="op">,</span> ret2<span class="op">);</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong></p>
<p><img src="exit测试.jpg" /></p>
<h3 id="cancel测试">cancel测试</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t2<span class="op">;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t3<span class="op">;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>fun1<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">1000000</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> <span class="dv">499999</span> <span class="op">&amp;&amp;</span> <span class="op">*((</span><span class="dt">int</span> <span class="op">*)</span>arg<span class="op">)</span> <span class="op">==</span> <span class="dv">12345</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>                pthread_cancel<span class="op">(</span>t3<span class="op">);</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>str <span class="op">=</span> <span class="st">&quot;hello!&quot;</span><span class="op">;</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>fun2<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    pthread_exit<span class="op">(</span>str<span class="op">);</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> umain<span class="op">()</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a1 <span class="op">=</span> <span class="dv">12345</span><span class="op">;</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a2 <span class="op">=</span> <span class="dv">10088</span><span class="op">;</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a3 <span class="op">=</span> <span class="dv">3381</span><span class="op">;</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> fun1<span class="op">,</span> <span class="op">&amp;</span>a1<span class="op">);</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t2<span class="op">,</span> NULL<span class="op">,</span> fun2<span class="op">,</span> <span class="op">&amp;</span>a2<span class="op">);</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t3<span class="op">,</span> NULL<span class="op">,</span> fun1<span class="op">,</span> <span class="op">&amp;</span>a3<span class="op">);</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>temp_1<span class="op">;</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>temp_2<span class="op">;</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>temp_3<span class="op">;</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t1<span class="op">,</span> <span class="op">&amp;</span>temp_1<span class="op">);</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40mthread 1 is finished!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t2<span class="op">,</span> <span class="op">&amp;</span>temp_2<span class="op">);</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40mthread 2 return the ptr of: </span><span class="sc">%s\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>temp_2<span class="op">);</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t3<span class="op">,</span> <span class="op">&amp;</span>temp_3<span class="op">);</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>temp_3 <span class="op">==</span> PTHREAD_CANCELED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>            writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40mthread 3 was canceled successfully!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>            writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;31;40mthread 3 return with wrong value!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong></p>
<p><img src="测试cancel.jpg" /></p>
<h3 id="cancel返回值测试">cancel返回值测试</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>fun1<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40mreciving &#39;</span><span class="sc">%s</span><span class="st">&#39;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>arg<span class="op">);</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">);</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m fun1 end !!!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> umain<span class="op">()</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>str <span class="op">=</span> <span class="st">&quot;hello!&quot;</span><span class="op">;</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> fun1<span class="op">,</span> str<span class="op">);</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    pthread_cancel<span class="op">(</span>t1<span class="op">);</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t1<span class="op">,</span> <span class="op">&amp;</span>ret<span class="op">);</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m t1 return the value of: </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> ret<span class="op">);</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> PTHREAD_CANCELED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m t1 was canceled successfully!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;31;40m t1 return with wrong value!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong></p>
<p><img src="cancel返回值测试.jpg" /></p>
<h3 id="cancel-point测试">cancel point测试</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t2<span class="op">;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>fun1<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40mreciving &#39;</span><span class="sc">%s</span><span class="st">&#39;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>arg<span class="op">);</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> <span class="dv">5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>            pthread_testcancel<span class="op">();</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">);</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m fun1 end !!!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> umain<span class="op">()</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>str <span class="op">=</span> <span class="st">&quot;hello!&quot;</span><span class="op">;</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> fun1<span class="op">,</span> str<span class="op">);</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t2<span class="op">,</span> NULL<span class="op">,</span> fun1<span class="op">,</span> str<span class="op">);</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    pthread_cancel<span class="op">(</span>t1<span class="op">);</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    pthread_cancel<span class="op">(</span>t2<span class="op">);</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t1<span class="op">,</span> <span class="op">&amp;</span>ret1<span class="op">);</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t2<span class="op">,</span> <span class="op">&amp;</span>ret2<span class="op">);</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m t1 return the value of: </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> ret1<span class="op">);</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m t2 return the value of: </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> ret2<span class="op">);</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret1 <span class="op">==</span> PTHREAD_CANCELED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m t1 was canceled successfully!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;31;40m t1 return with wrong value!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret2 <span class="op">==</span> PTHREAD_CANCELED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m t2 was canceled successfully!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;31;40m t2 return with wrong value!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong></p>
<p><img src="cancel%20point%20测试.jpg" /></p>
<h3 id="asynchronous-cancel测试-1">asynchronous cancel测试 1</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t2<span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>fun1<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40mreciving &#39;</span><span class="sc">%s</span><span class="st">&#39;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>arg<span class="op">);</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> oldtype<span class="op">;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        pthread_setcanceltype<span class="op">(</span>THREAD_CANCEL_ASYNCHRONOUS<span class="op">,</span> <span class="op">&amp;</span>oldtype<span class="op">);</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40mthread </span><span class="sc">%d</span><span class="st"> old_cancel_ype is &#39;</span><span class="sc">%d</span><span class="st">&#39;, new_cancel_type is &#39;</span><span class="sc">%d</span><span class="st">&#39;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                    pthread_self<span class="op">(),</span> oldtype<span class="op">,</span> THREAD_CANCEL_ASYNCHRONOUS<span class="op">);</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> <span class="dv">5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>            pthread_cancel<span class="op">(</span>pthread_self<span class="op">());</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">);</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m fun1 end !!!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> umain<span class="op">()</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>str <span class="op">=</span> <span class="st">&quot;hello!&quot;</span><span class="op">;</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> fun1<span class="op">,</span> str<span class="op">);</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t2<span class="op">,</span> NULL<span class="op">,</span> fun1<span class="op">,</span> str<span class="op">);</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t1<span class="op">,</span> <span class="op">&amp;</span>ret1<span class="op">);</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t2<span class="op">,</span> <span class="op">&amp;</span>ret2<span class="op">);</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m t1 return the value of: </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> ret1<span class="op">);</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m t2 return the value of: </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> ret2<span class="op">);</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret1 <span class="op">==</span> PTHREAD_CANCELED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m t1 was canceled successfully!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;31;40m t1 return with wrong value!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret2 <span class="op">==</span> PTHREAD_CANCELED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m t2 was canceled successfully!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>        writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;31;40m t2 return with wrong value!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong></p>
<p><img src="asys%20cancel测试1.jpg" /></p>
<h3 id="asynchronous-cancel测试-2">asynchronous cancel测试 2</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t2<span class="op">;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>fun1<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40mthread </span><span class="sc">%d</span><span class="st"> reciving &#39;</span><span class="sc">%s</span><span class="st">&#39;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> pthread_self<span class="op">(),</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>arg<span class="op">);</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    pthread_setcanceltype<span class="op">(</span>THREAD_CANCEL_ASYNCHRONOUS<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t2<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">);</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m fun1 end !!!</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>fun2<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40mthread </span><span class="sc">%d</span><span class="st"> reciving &#39;</span><span class="sc">%s</span><span class="st">&#39;</span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> pthread_self<span class="op">(),</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>arg<span class="op">);</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    syscall_yield<span class="op">();</span>    </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    pthread_cancel<span class="op">(</span>t1<span class="op">);</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> umain<span class="op">()</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>str <span class="op">=</span> <span class="st">&quot;hello!&quot;</span><span class="op">;</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> fun1<span class="op">,</span> str<span class="op">);</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t2<span class="op">,</span> NULL<span class="op">,</span> fun2<span class="op">,</span> str<span class="op">);</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t1<span class="op">,</span> <span class="op">&amp;</span>ret1<span class="op">);</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t2<span class="op">,</span> <span class="op">&amp;</span>ret2<span class="op">);</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m t1 return the value of: </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> ret1<span class="op">);</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    writef<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m t2 return the value of: </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> ret2<span class="op">);</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong></p>
<p><img src="asys%20cancel测试2.jpg" /></p>
<h3 id="测试">测试</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode cpp"><code class="sourceCode cpp"></code></pre></div>
<p><strong>测试结果</strong></p>
<p>[]</p>
<h3 id="信号量创建取值销毁测试">信号量创建、取值、销毁测试</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t2<span class="op">;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t3<span class="op">;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="dt">sem_t</span> s1<span class="op">;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>func<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> sem_trywait<span class="op">(&amp;</span>s1<span class="op">);</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>            sem_getvalue<span class="op">(&amp;</span>s1<span class="op">,</span> <span class="op">&amp;</span>value<span class="op">);</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m thread </span><span class="sc">%d</span><span class="st"> call the `sem_trywait`, retval is </span><span class="sc">%d</span><span class="st">, s1&#39;s value is </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>                pthread_self<span class="op">(),</span> ret<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> umain<span class="op">()</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> msg <span class="op">=</span> <span class="st">&quot;hello, world&quot;</span><span class="op">;</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> value <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    sem_init<span class="op">(&amp;</span>s1<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m after init, s1 perm is </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> s1<span class="op">.</span>sem_perm<span class="op">);</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>s1<span class="op">.</span>sem_perm <span class="op">==</span> SEM_PERM_VALID<span class="op">)</span> </span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    \<span class="bn">033</span><span class="op">[</span><span class="dv">0</span><span class="op">;</span><span class="dv">34</span><span class="op">;</span><span class="dv">40</span><span class="er">m</span> s1 is valid<span class="op">!</span> \<span class="bn">033</span><span class="op">[</span><span class="dv">0</span><span class="er">m</span>\n<span class="st">&quot;);</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    sem_getvalue<span class="op">(&amp;</span>s1<span class="op">,</span> <span class="op">&amp;</span>value<span class="op">);</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m s1 value is </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> s1<span class="op">.</span>sem_value<span class="op">);</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> func<span class="op">,</span> msg<span class="op">);</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t2<span class="op">,</span> NULL<span class="op">,</span> func<span class="op">,</span> msg<span class="op">);</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// wait for t1</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t1<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t2<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    sem_destroy<span class="op">(&amp;</span>s1<span class="op">);</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m s1 after destroy, perm is </span><span class="sc">%d\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> s1<span class="op">.</span>sem_perm<span class="op">);</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>s1<span class="op">.</span>sem_perm <span class="op">!=</span> SEM_PERM_VALID<span class="op">)</span> </span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;34;40m s1 is invalid! </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong></p>
<p><img src="sem基础测试.jpg" /></p>
<h3 id="生产者消费者模型测试">生产者消费者模型测试</h3>
<p><strong>测试例程</strong></p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;lib.h&quot;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pthread_t</span> t1<span class="op">,</span> t2<span class="op">;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="dt">sem_t</span> mutex<span class="op">,</span> empty<span class="op">,</span> full<span class="op">;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> max <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>prodecer<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        sem_wait<span class="op">(&amp;</span>empty<span class="op">);</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        sem_wait<span class="op">(&amp;</span>mutex<span class="op">);</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        count<span class="op">++;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;32;40m produce successfully, no count is </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> count<span class="op">);</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        sem_post<span class="op">(&amp;</span>mutex<span class="op">);</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>        sem_post<span class="op">(&amp;</span>full<span class="op">);</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>consumer<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>        sem_wait<span class="op">(&amp;</span>full<span class="op">);</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        sem_wait<span class="op">(&amp;</span>mutex<span class="op">);</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>        count<span class="op">--;</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\033</span><span class="st">[0;31;40m consume successfully, no count is </span><span class="sc">%d</span><span class="st"> </span><span class="sc">\033</span><span class="st">[0m</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> count<span class="op">);</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>        sem_post<span class="op">(&amp;</span>mutex<span class="op">);</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>        sem_post<span class="op">(&amp;</span>empty<span class="op">);</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> umain<span class="op">()</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>   </span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    sem_init<span class="op">(&amp;</span>mutex<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>    sem_init<span class="op">(&amp;</span>empty<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> max<span class="op">);</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    sem_init<span class="op">(&amp;</span>full<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t1<span class="op">,</span> NULL<span class="op">,</span> prodecer<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    pthread_create<span class="op">(&amp;</span>t2<span class="op">,</span> NULL<span class="op">,</span> consumer<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t1<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    pthread_join<span class="op">(</span>t2<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>测试结果</strong><br />
<img src="生产者消费者.jpg" /></p>
